# 轻智能家居硬件层通信协议

| 版本号    |      | 发布者        | 时间   |
| ------ | ---- | ---------- | ---- |
| v1.0.0 | 初始发布 | Dave Huang | 未定   |
| 空      | 空    | 空          | 空    |
| 空      | 空    | 空          | 空    |

***

## 协议结构

|      | 开始码       | 包长      | 发起者子网ID           | 发起者设备ID             | 发起者类型         | 目标子网ID          | 目标设备ID              | 操作码            | 附加信息               | 加密字段         | CRC校验 |
| ---- | --------- | ------- | ----------------- | ------------------- | ------------- | --------------- | ------------------- | -------------- | ------------------ | ------------ | ----- |
|      | StartCode | Len     | Original SubnetID | Original DeviceID   | Original Type | Target SubnetID | Target DeviceID     | Operation Code | Additional Content | Code Content | CRC   |
| 数据类型 | 2个字节      | 2个字节    | 1个字节              | 2个字节                | 2个字节          | 1个字节            | 2个字节                | 2个字节           | 0-N字节              | 10字节         | 2字节   |
| 数据范围 | 0xACAC    | 26-94字节 | 1-254(255为广播信道)   | 1-65534(65535为广播信道) | 1-65535       | 1-254(255为广播信道) | 1-65534(65535为广播信道) | 1-65535        | 0-N                | 10字节         | 2字节   |
| SN   | 1         | 2       | 3                 | 4                   | 5             | 6               | 7                   | 8              | 9                  | 10           | 11    |

### 开始码
开始码是用于作为开始传输命令的符号，设备会判断以此开头的数据才会进行接收。

### 包长
包长=SN2开始算起到SN11

### 发起者子网ID&发起者设备ID
发起者的ID，发起者可以是设备，或者app使用者，或者是网络端等等

### 发起者类型
用于分辨发起者的身份

### 目标子网ID&目标设备ID
发送给对方的ID，这样就可以清楚知道是什么设备发送给什么设备

### 操作码
类似命令，指的是进行什么操作，例如开灯，关灯等等，每个设备都有自己的操作码，同时系统也有一些公用的操作码，
例如读取温度值等，这些是公用属性，几乎每个有温度模块的设备都必须遵守该操作码

### 附加数据
每个设备的每条指令的附加数据格式都不一样，具体要看设备的规格书

### 加密字段
主要用于数据的加密，就算数据被监听到，重复发送该数据还是不能控制设备的；这里的主要应用和算法在下文说明。

### CRC校验
用于校验整条指令的完整性，校验错误的话就放弃该指令

## 协议相关详情
### 加密算法
在加密字段处，我们需要加上加密算法，防止数据被读取了进行恶意操控。

我们采用异或对称加密算法，对ascii码的“SmartVeewap”数组进行异或，采用什么数据进行异或呢？

目前采用：时间戳6字节+发起者唯一ID后4字节=10字节进行加密，具体算法会在相关语言SDK中；

**注意** 这里涉及到时间戳，但是有一些设备是没有RTC功能的，所以没办法计算，这时候需要区分一下，

* 低功耗设备，对省电要求高，这类型的设备需要直接把6字节设成0xff ff ff ff ff ff+ID后4字节发送到网关，网关进行转发。
* 非低功耗设备，但是没有RTC实时时钟，由网关每30min广播一次时间事件，所有设备进行校准，没RTC的用定时器定时30min。有RTC的直接进行校准就可以了。

### CRC校验

使用CRC16查表校验算法，具体实现会在相关语言SDK中；

## 消息处理机制

### 收发重发机制

- 网关向终端设备发送报文消息，终端设备在一定时间内收到该消息后应返回相关的报文消息作为回复。


- 网关在T1秒时间内收到终端设备回复的报文消息，那么说明消息发送成功；但如果网关在该时间内未收到终端设备的回复消息，将重新发送该报文消息。



- 若重发N1次后网关仍然没有收到终端设备的回复消息，那么将认为报文消息发送失败。其中时间间隔T1和重发次数N1都是可配置的参数，该参数由网关配置到终端设备进行保存；T1推荐值为5秒，N1推荐值为2次。
- 网关发送报文消息的时候相关通信模块（有线为can，无线为lora）必须要判断当前网络是处于空闲的状态，除非网络本身具有防止信息拥堵的功能。

### 心跳机制

特殊的设备-低功耗设备需要有心跳机制，循环每T2时间内向网关发送心跳包信号，网关N2次没有收到消息则认为该设备为离线状态，T2推荐100秒，N2推荐3次；

## 地理分区

 每个家庭单元可能拥有一个住所，也有可以拥有多个不同的住所，如一个常住的住所和一个用于度假的别墅。这些依据住所之间可能相距很远，但他们都属于同一个家庭。每个住所由多个房间组成，这些房间可能还会分上下楼，具体的分区由用户自己决定，每个家庭的房间也有所不同。

### 分区层级

1. **家庭**作为整个分组的根， 其包含一个或多个住所。
2. **住宅**是包含一个或多个区域的住所，一个家庭可能拥有多个住所，例如一个主要的住宅和一个度假的别墅。一般而言，一个家庭至少包含一个住所，这个住所也可以不在同一个地方，但在逻辑上它是一体的。
3. **区域**是房间和场所的集合，比如“楼上”、“楼下”和“车库”等。每个住所包含一个或多个区域、每个区域由一个或多个房间或场所组成。
4. **房间**是分区的最小单位，每个住所包含一个或多个房间。

## 设备的设置与变量

### 设备ID

每个设备必须保存有自身的子网ID和设备ID，并且出厂前需要设置好套装ID，保证不会重复。

### 设备唯一标识

每个设备必须要有唯一的设备标识，就是设备自定义8位随机生成的mac地址

### 版本号

每个设备都有版本号，为4个字节，如v1.0.0.1版本，前2字节为pcb版本，后2字节为固件版本；如果只是固件修改的话，更新版本号直接升级后2位，如：v1.0.0.2；但是如果pcb板更改了，固件就不能升级到不同pcb板的固件，例如智能面板revL的版本为v1.3.0.9,进行了一次固件更新，网关就会推送用户更新固件v1.3.0.a，但是接下来公司把智能面板revL的pcb修改了，现在的固件版本为v1.4.0.1，这时候网关不会推送用户更新固件版本，因为v1.3pcb下面的固件版本最新的就是v1.3.0.a了；

### 设备地理分区标识

每个设备都需要设置地理分区，例如现在卖出一个套装用于别墅，套装包括了1楼，2楼，车库；1楼2个大厅3个房间，2楼4个房间；这时候放到1楼卫生间的开关就需要设置地理分区为：家庭1-别墅-1楼-卫生间，这样的地理标志。

### 设备出厂前设置

* 设置设备的ID（子网ID和设备ID），保证不会和套装内其他设备产生冲突
* 设置设备的地理分区
* 搭建套装系统测试

### 设备开发必须有的功能

* 被网关搜索到的功能，网关搜索的时候返回mac地址和地理分区和设备版本号
* 解决设备ID冲突机制，设备上电运行的时候会发送一次自身ID给网关，网关发现有冲突的话会发送指令修改ID
* 修改设备ID功能
* 修改设备mac地址功能
* 修改设备地理分区功能
* 修改设备名称功能取消，不要绑定设备比较好
* 读取固件版本号
* 固件升级后支持回退上一版本固件功能

## 关于接入第三方设备

本系统使用的是can总线和lora相结合的功能，但是网关可以扩展其他模块，达到接入其他第三方设备的功能，例如可以添加zigbee模块，ble模块，433/311模块等等；

网关和这些模块直接的链接都使用uart口进行控制；

* 移动端或者云端控制第三方设备的指令也必须根据本协议，指令去到网关处网关进行协议转换再对第三方设备进行控制。
* 当有新的第三方设备接入时，移动端可以更新app程序实现支持，网关也可以通过更新网关程序实现支持，但是轻智能的终端设备是不需要进行程序更新的，只要网关把终端设备相应事件的目标ID修改成第三方设备，网关程序就能接收到该事件，并进行转换去控制第三方设备。

## 硬件层SDK

### SDK提供功能

硬件层SDK主要提供如何使用c语言（因为大部分嵌入式设备都是用c语言编写固件的）对需要发送的内容进行封包，封装成本协议的格式；还有如何解析接收到的数据的功能；里面包括了如何加密，解密，CRC校验等；

### SDK例子



## 附录

#### 发起者类型：

| 代码    | 类型对象      |
| ----- | --------- |
| 1     | 网关        |
| 2     | 电脑        |
| 3     | 安卓app     |
| 4     | 苹果app     |
| 5     | 云服务器      |
| 6     | 1路继电器开关   |
| 7     | 2路继电器开关   |
| 8     | 3路继电器开关   |
| 9     | 6路继电器开关   |
| 10    | 8路继电器开关   |
| 11    | 12路继电器开关  |
| 12    | 16路继电器开关  |
| 13    | 1路调光器     |
| 14    | 2路调光器     |
| 15    | 3路调光器     |
| 16    | 6路调光器     |
| 17    | 8路调光器     |
| 18    | 12路调光器    |
| 19    | 16路调光器    |
| 20    | 轻智能传感器9合1 |
| 21    | 轻智能传感器8合1 |
| 22    | 轻智能传感器5合1 |
| 23    | 轻智能传感器3合1 |
| 24    | 1路继电器开关面板 |
| 25    | 2路继电器开关面板 |
| 26    | 3路继电器开关面板 |
| 27    | 4路继电器开关面板 |
| 28    | 轻智能音箱     |
| 29    | 轻智能床边面板   |
| 30    | 轻智能面板revL |
| 31    | 轻智能面板revN |
| 32    | 轻智能面板revF |
| 33    | 轻智能音乐中心   |
| 34    | 轻智能红外中心   |
| 35    | 智能门磁      |
| 36    | 水位传感器     |
| 37    | 风速传感器     |
| 。。。   | 。。。       |
| 65535 | xxx       |




#### 操作码：通用操作码请见command文件。

#### 地理分区：

地理分区一共4个字节，分别为家庭类型-住宅类型-区域类型-空间类型，目前仅定义家庭类型：

| 代码   | 家庭类型     | 住宅类型 | 区域类型 | 空间类型 |
| ---- | -------- | ---- | ---- | ---- |
| 0x00 | 无        | 无    | 无    | 无    |
| 0x01 | 家庭       | 普通住宅 | 1楼   | 门厅1  |
| 0x02 | 酒店（未定义）  | 别墅   | 2楼   | 门厅2  |
| 0x03 | 广场（未定义）  | 1栋   | 3楼   | 客厅1  |
| 0x04 | 商场（未定义）  | 2栋   | 4楼   | 客厅2  |
| 0x05 | 博物馆（未定义） | 3栋   | 5楼   | 客厅3  |
| 0x06 | 学校（未定义）  | 4栋   | 6楼   | 卫生间1 |
| 0x07 | 医院（未定义）  | 5栋   | 7楼   | 卫生间2 |
| 0x08 | 游乐场（未定义） |      | 8楼   | 卫生间3 |
| 0x09 | 。。。      |      | 9楼   | 卫生间4 |
| 0x0a |          |      | 10楼  | 卫生间5 |
| 0x0b |          |      | 前庭院  | 饭厅1  |
| 0x0c |          |      | 后庭院  | 饭厅2  |
| 0x0d |          |      | 车库   | 过道1  |
| 0x0e |          |      |      | 过道2  |
| 0x0f |          |      |      | 过道3  |
| 0x10 |          |      |      | 楼梯   |
| 0x11 |          |      |      | 阳台1  |
| 0x12 |          |      |      | 阳台2  |
| 0x13 |          |      |      | 主卧室  |
| 0x14 |          |      |      | 次卧室  |
| 0x15 |          |      |      | 厨房   |
| 0x16 |          |      |      | 书房   |
| 0x17 |          |      |      | 杂物房  |
| 0x18 |          |      |      | 洗衣房  |
| 0x19 |          |      |      | 客房1  |
| 0x1a |          |      |      | 客房2  |
| 0x1b |          |      |      | 婴儿房1 |
| 0x1c |          |      |      | 婴儿房2 |

#### 名称等级

|          | 名称   |
| -------- | ---- |
| 0x000001 | 爸爸   |
| 0x000002 | 妈妈   |
| 0x000003 | 哥哥   |
| 0x000004 | 姐姐   |
| 0x000005 | 弟弟   |
