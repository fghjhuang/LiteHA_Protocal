# 轻智能家居系统架构

|      | 版本号    | 发布者        | 时间   |
| ---- | ------ | ---------- | ---- |
| 初始发布 | v1.0.0 | Dave Huang | 未定   |
| 空    | 空      | 空          | 空    |

## 系统架构

总体架构采用远程：设备-网关-云-移动端；局域网：设备-网关-移动端；控制的方式。

- 局域网：

  1）设备-网关之间采用可选2种通信方式，无线/有线；无线采用lora技术（原因在下文注释中分析），有线采用CAN-Bus技术（原因在下文注释中分析）；具体情况用哪种方式看客户决定；

  2）网关会使用UDP转发（广播255.255.255.255）符合协议的所有指令到局域网，所以移动端在家庭内可以实时收到设备状态的改变；

  3）移动端不需要搜索网关ip地址，移动端对设备进行控制，只需要在局域网内进行指令广播，网关收到后会判断并进行转发到设备网络，相关设备收到数据后进行指令控制；

  *为什么采用lora：lora是一种窄带广域网技术，传输数据速率低，但是距离远，可以很方便的就用一个网关就可以覆盖整栋别墅；不需要像zigbee，ble那样做复杂的设备管理和不断的进行路由中继还有2.4G冲突；只要做好网关维护就可以做好整个系统，万一需要维修也有导出导入数据机制和方便换网关机制；

  *为什么采用CAN-Bus，can总线是有线传输里面十分可靠的一个技术，也是距离长，速率低的代表之一，当然还有KNX，485等技术，所以这里的有线技术采用只看个人喜好；

  *网关对数据的判断主要体现在会解密加密字段，只有时间有效范围（时间戳1min）内的数据，解密出来的发起者唯一ID后4字节和网关保存的白名单ID后4字节列表要一致，CRC校验通过，才会转发到系统；

- 广域网：

  1）设备-网关之间继续采用局域网的通信方式，除了局域网，网关也会通过websocket转发数据到服务器，服务器再通过udp广播转发到各移动端；

  2）网关-云之间采用Websocket长链接，实时全双工保证数据可靠；网关与云端详细架构请参考云端架构的文档，云端发送数据到网关的时候会有个前缀（设备唯一标识前32位）+具体内容，网关收到后分别唯一标识时效和是否在白名单，再进行转发到系统内部；

  3）云-移动端之间采用udp协议，不采用tcp/websocket等链接方式，因为udp可以消耗最少的资源传递给所有的移动端；

## 关于网关

### 多功能集成

网关可以集成很多其他第三方的设备，通过在网关上添加不同的模块，例如添加zigbee标准协调器模块，可以接入所有zigbee标准设备；添加433MHZ模块，可以控制窗帘和车库的门；等等

### 数据验证

网关对所有数据进行筛选控制，主要是设备-网关（can/lora），移动端-网关（局域网udp），云-网关（websocket）3种数据，主要遵循以下一些原则：

* 所有指令的有效期为1min，如果解密加密字段中的时间戳的时间和接收到的时间相差1min外，网关不进行处理。
* 网关内部保存有所有可控制设备的白名单的唯一ID，特别是app端的手机的唯一标识，解密加密字段得到的4位数据是唯一标识的后4位数，如果数据不在白名单里面的话，网关也不处理。
* CRC校验失败的不处理。

### 升级机制

网关的升级，甚至包括所有设备的升级都是一个很复杂很难把控的事情，具体机制如下：1）每个设备都会配备硬件升级端口，防止无线/有线升级失败的情况；2）每个设备都会有版本回退功能，防止升级后功能体验不好，用户需要回退版本；3）有线升级设备固件是可行的，可以通过移动端通过网关对设备进行升级；但是无线升级需要进行实际测试，因为lora无线速率比较低，所以不一定支持固件升级，暂定使用无线的时候需要手动取硬件连接电脑进行固件升级；4）所有设备的升级都是从上到下的，网关会检查网关固件支持的设备的最新的版本号，然后推送用户进行设备固件更新，但是注意一下，网关不会提醒用户进行网关程序更新，因为网关程序是家庭中心，没有太大问题，不建议用户更新；

### 不经过网关的设备

对于一些音视频设备是不能通过网关的，因为网关的数据传输速率是比较低的，音视频要求实时数据传输，所以需要用到wifi，这时候，这些设备就连接到专用的云端后台进行服务，网关负责传输数据量少的控制指令，例如开关等。

### 账号验证机制

账号验证机制，轻智能家居主要采用网关白名单的形式提供服务，局域网：家庭的每一台手机都需要在网关进行登记，才可以在局域网对家庭设备进行控制，不需要用户名密码进行登录，但是打开app的时候app会发送手机唯一标识给网关，网关会授权白名单用户30分钟的控制时间；广域网：需要手机进行账号密码进行登录才可以控制，登录成功的时候，app会发送手机唯一标识给云，云端会判断白名单，如果不是白名单的手机进行控制的话，云端会拒绝访问，手机端需要提醒用户需要原手机短信验证才可以授权1次性的30min控制；

## 数据库保存

移动端和网关（网关白名单列表的用户都可以改写网关数据）采用sqlite数据库保存设备表数据，云端采用mysql数据库；3个数据库中，网关保存的数据是完整的，移动端只保存设备的表格，云端只保存远程用户表（用户名，密码，相关信息，网关唯一ID等）；

**如何进行数据库同步** ：每个数据库都会有一个表专门存一个字段：数据库表校验码（128字节），每当数据库内容被改写的时候，都需要更新这个校验码；

* 网关每次更新校验码都会发校验码到云端同步云端的该网关的设备表校验码，移动端每次修改设备也会更新移动端本地的设备表校验码然后发送到云端，当云端接收到移动端设备表校验码和网关的对比不一样的时候，云端不会对数据库进行修改，并会提醒移动端从云端重新下载设备表；场景：删除了app重新登录，换手机登录等。
* 只有移动端在本地局域网的时候修改本身数据库（并更新校验码），发送修改内容给网关，网关才会进行修改自己的数据库并更新校验码和同步校验码到云端。

## 关于移动端

### 移动端框架

#### App-云

app与云服务器采用的是基于udp的传输协议，发送的数据结构为HAL协议里面的一模一样，但是是json格式的数据格式。

#### App-网关

app在局域网状态下会使用基于udp的传输协议，发送的数据接口和HAL的一样，是字节类型，不是json格式，app可以通过SDK转换成json格式。使用字节类型的目的是减少网络数据流，json格式的数据量会相对比字节类型大。

#### App-非网关管理设备

app与非网关管理的设备沟通的时候，是直接通过云端使用，大流量数据直接经过云服务器。

#### 移动端的设备唯一标识

android：1+androidID（64位数字）

ios：2+advertisingidentifier

android 平板：3+androidID（64位数字）

ios 平板：4+advertisingidentifier



### 移动端SDK

#### 移动端SDK提供功能

1）移动端SDK主要提供对数据封装成HAL数据结构的功能，还有解析数据包功能；另外还有把解析的数据包转成json数据格式返回，把json数据转成封包的数据功能。

2）基于udp的完善的通信机制的库。

3）对sqlite数据进行高效操控的库。

4）http请求库。

#### 移动端SDK使用例子



## 关于云服务器

### 云服务器架构

云端架构：主服务器-分服务器的形式，第一次联网的时候，

* 网关：http请求主服务器，主服务器返回目标服务器的ip地址/域名和端口号，然后网关就保存目标服务器的ip，并请求进行websocket连接，如果以后断电重启都会直接连接目标服务器。
* 手机端：http请求主服务器，主服务器返回网关连接的服务器的ip地址/域名和端口号，手机保存ip/域名数据并进行udp监听数据，以后重启app直接监听，切换不同的网关也是一样的操作。
* 假如网关清空了数据，或者重新换了一个网关，网关会重新请求主服务器ip/域名，主服务器有保存所有网关和移动端设备的分服务器地址，所以主服务器会重新分配给网关。同样的情况也是适用于移动端的。
* 移动端使用远程控制家庭设备的时候，app会登录，然后发送手机唯一标识给云端，云端第一次会把网关唯一标识，手机唯一标识和手机云端账号密码绑定，然后进行数据转发；如果手机端换了手机，云端发现手机唯一标识不一样，
  * 云端会返回1）是否已经换手机。2）只是临时使用一次。给app端。
  * 然后需要app进行手机验证码验证
  * 验证成功后，如果用户是要换手机的（临时使用的情况，会临时使用验证的唯一标识进行通信30min），云端会把旧的手机唯一标识发送到网关进行删除（云端网关数据库都删除该唯一标识），然后发送新的手机唯一标识发送到网关进行登录（更新网关和云端的数据库），然后用新的唯一标识进行通信。

云端的数据库架构为集中式管理，因为智能家居的用户量还不大，一个服务器可以存好多年的数据量，而且保存在云端的数据库表内容不多，所以直接使用一个数据库服务器，分服务器请求数据库数据的时候直接请求该服务器的数据就可以了。

云端的主要功能：

1.保存所有网关和移动端的分服务器地址。

2.保证移动端的数据库和网关同步。

3.数据转发，websocket转udp广播。

4.保存所有移动端账号密码。

### 云服务器SDK

#### 云服务器SDK提供功能

1）基于udp的完善的库，用于和移动端通信

2）websocket库，用于和网关进行通信

3）操控sqlite数据库的库

4）基于本协议的逻辑库

#### 云服务器SDK使用例子



## 数据库表结构

### 移动端数据库

#### 设备表（device）：手机不能修改

|      | 设备名称（device name） | 设备子网ID（subnetID） | 设备设备ID（deviceID） | 设备类型（deviceType） | 设备地理分区（location） | 设备额外信息json（additional） | *备注（不是表格一部分） |
| ---- | ----------------- | ---------------- | ---------------- | ---------------- | ---------------- | ---------------------- | ------------ |
| 1    | 客厅大灯              | 1                | 2                | 0x0001           | 0x01010103       | {channel:1}            |              |
| 2    | 客厅小灯              | 1                | 2                | 0x0001           | 0x01010103       | {channel:2}            |              |
| 3    | 厨房灯               | 1                | 3                | 0x0001           | 0x01010115       | {channel:3}            |              |

#### 地理分区表（location）：手机不能修改

|      | 分区值（locvalue） | *备注（不是表格一部分）     |
| ---- | ------------- | ---------------- |
| 1    | 0x01010103    | 具体取值请参考地理分区定义的表格 |
| 2    | 0x01010105    |                  |
| 3    | 0x01010115    |                  |

#### 情景列表（mood）：手机不能修改

|      | 情景名称（name） | 情景ID（specID） | 地理分区值（locvalue） | *备注（不是表格一部分） |
| ---- | ---------- | ------------ | --------------- | ------------ |
| 1    | 回家         | 0x12aabbcc   | 0x01010103      | 表示为客厅的情景     |
| 2    | 吃饭         | 0x12bbccdd   | 0x01010115      | 表示为厨房的情景     |
| 3    |            |              |                 |              |

#### 系统设置表（sys）：手机可修改

|      | 项目     | 项目值                        |
| ---- | ------ | -------------------------- |
|      | ip地址   | 10.22.123.12               |
|      | 域名     | www.veewap.com/app_request |
|      | 设备表校验码 | 0x12fabcedfac.....1122     |



### 云端数据库

#### 设备表

#### 地理分区表

#### 情景列表

云端的设备表，地理分区表，情景列表这3个表的格式和移动端的数据库一样。

#### 账号密码表

|      | 用户名       | 密码     | 邮箱                     | 用户唯一标识                | 网关唯一标识                    |
| ---- | --------- | ------ | ---------------------- | --------------------- | ------------------------- |
| 0    | fghjhuang | 123123 | 空                      | 0x1234689213467812364 | "12:34:55:23:33:22:22:11" |
| 1    | test      | 123123 | justforojbonly@126.com | 0x87q7861283487221343 | "12:34:55:23:33:22:22:11" |
| 2    | test2     | 123123 | 123xxxx@qq.com         | 0x1236873468769823146 | "12:34:55:23:33:22:22:11" |



### 网关数据库

#### 设备表

#### 地理分区表

#### 情景列表

网关的设备表，地理分区表，情景列表这3个表的格式和移动端的数据库一样。

#### 白名单表

|      | 名称等级（3字节）name | 设备类型deviceType | 设备64位唯一标识 unique code | 权限(默认3)level | 备用remark |
| ---- | ------------- | -------------- | --------------------- | ------------ | -------- |
| 0    | 0x000001(爸爸)  | 1（安卓手机）        | xxxxxxx               | 3            | 空        |
| 1    | 0x000002(妈妈)  | 2（苹果手机）        | xxxxxxx               | 3            | 空        |
| 2    | 0x000003(哥哥)  | 3（安卓平板）        | xxxxxxx               | 3            | 空        |

#### 情景内容表

#### 设备固件列表





